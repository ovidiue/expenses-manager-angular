<div class="container" [@fadeIn]>
  <div class="page-title">
    <h3>Expenses</h3>
  </div>

  <div class="row">
    <p-sidebar [(visible)]="displaySidebar" position="top" [styleClass]="'top-sidebar'">
      <div class="ui-g">
        <div class="ui-g-12 ui-g-offset-1">
          <h2>Category</h2>
        </div>
        <div class="ui-g-1"></div>
        <div class="ui-g-10">
          <div class="ui-g-6">
            <p-dropdown [options]="categories"
                        [showClear]="true"
                        [(ngModel)]="categoryToAssign"
                        [placeholder]="'Select category'"
                        [style]="{'width':'100%'}">
              <ng-template let-item pTemplate="selectedItem">
                <span [ngStyle]="{background: item.color}" class="selected-cat"></span>
                <span style="font-size:14px;margin-left:10px;margin-top:4px">{{item.label}}</span>
              </ng-template>
              <ng-template let-cat pTemplate="item">
                <div class="ui-helper-clearfix" style="position: relative;height: 25px;">
                  <span
                      [ngStyle]="{background: cat.color, width: '50%', height: '100%', display:'inline-block'}"></span>
                  <span style="font-size:14px;float:right;margin-top:4px">{{cat.label}}</span>
                </div>
              </ng-template>
            </p-dropdown>
          </div>
          <div class="ui-g-6">
            <button type="button"
                    pButton
                    (click)="resetAssignVariables()"
                    class="ui-button-raised ui-button-secondary"
                    label="Cancel">
            </button>
            <button type="button"
                    pButton
                    (click)="assignNewCategory()"
                    class="ui-button-raised ui-button-success"
                    label="Save">
            </button>
          </div>

        </div>
        <div class="ui-g-1"></div>

      </div>

    </p-sidebar>

    <p-overlayPanel #op>
      <p-scrollPanel [style]="{width: '300px', height: '200px'}">
        <div style="padding:1em;line-height:1.5">
          {{selectedDescription}}
        </div>
      </p-scrollPanel>
    </p-overlayPanel>
    <!--TABLE FILTERS START-->
    <app-expense-filter (filterChange)="searchValues($event)"
                        class="col">
    </app-expense-filter>
    <!--TABLE FILTERS END-->

    <div class="table-wrapper mt-5 mb-5">
      <div class="col">
        <p-toolbar>
          <div class="ui-toolbar-group-right">
            <p-dialog [rtl]="true"
                      modal="true"
                      [closable]="false"
                      [visible]="displayDelete"
                      [header]="'Confirm DELETE'">
              <span>{{deletionText}}</span>
              <p>This action can not be undone!</p>
              <p-footer class="three-button">
                <button type="button"
                        [class]="'ui-button-secondary float-left ui-button-secondary ui-button-raised'"
                        pButton
                        icon="pi pi-times"
                        label="Cancel"
                        (click)="resetDeletionVariables()">
                </button>
                <button type="button"
                        [class]="'ui-button-danger ui-button-raised'"
                        pButton
                        icon="pi pi-check"
                        label="Delete"
                        (click)="displayDelete=true; deleteExpense()">
                </button>
                <button type="button"
                        [class]="'ui-button-danger ui-button-raised extra-danger'"
                        pButton
                        *ngIf="decideVisibilityAccordingToPayedField()"
                        icon="pi pi-check"
                        label="Delete rates too"
                        (click)="deleteExpenseAndRates()">
                </button>
              </p-footer>
            </p-dialog>
            <p-splitButton label="Add Expense"
                           icon="pi pi-file"
                           class="ui-button-raised"
                           (onClick)="goToAddExpense()"
                           [model]="tableOptions.actions">
            </p-splitButton>
          </div>
        </p-toolbar>

      </div>
      <div class="col">
        <p-table [value]="expenses"
                 [responsive]="true"
                 [paginator]="expenses.length > 0"
                 [paginatorPosition]="tableDefaults.paginatorPosition"
                 [scrollable]="tableDefaults.scrollable"
                 [scrollHeight]="tableDefaults.scrollHeight"
                 [rowHover]="tableDefaults.rowHover"
                 [reorderableColumns]="tableDefaults.reorderableColumns"
                 [rows]="tableDefaults.defaultRows"
                 [totalRecords]="tableOptions.totalTableRecords"
                 [loading]="tableDefaults.loading"
                 [rowsPerPageOptions]="tableDefaults.rowsPerPageOptions"
                 [lazy]="true"
                 [sortField]="'createdOn'"
                 [sortOrder]="-1"
                 (onLazyLoad)="getExpenses($event)"
                 [(selection)]="selectedExpenses">
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 3em">
                <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
              </th>
              <th *ngFor="let col of tableOptions.columns"
                  [pSortableColumn]="col.value">
                {{col.name}}
                <p-sortIcon [field]="col.value"></p-sortIcon>
              </th>
              <th class="actions-width">Actions</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-exp>
            <tr [pSelectableRow]="exp">
              <td>
                <p-tableCheckbox [value]="exp"></p-tableCheckbox>
              </td>
              <td>{{exp.title}}</td>
              <td>{{exp.amount}}</td>
              <td>
                <div *ngIf="exp.description && exp.description.length > 15; else smallerDesc"
                     style="cursor:pointer;"
                     pTooltip="Click for detailed info"
                     (click)="selectedDescription=exp.description;op.toggle($event)">
                  {{exp.description.length > 15 ? (exp.description | slice:0:20) + '...' :
                    exp.description}}
                </div>
                <ng-template #smallerDesc>
                  <div>
                    {{exp.description}}
                  </div>
                </ng-template>
              </td>
              <td>{{exp.recurrent}}</td>
              <td>{{exp.createdOn | date}}</td>
              <td>{{exp.dueDate | date}}</td>
              <td>
                <span *ngIf="exp.category && exp.category.name"
                      class="bottom-bradius"
                      [ngStyle]="{'border-bottom': '8px solid' + exp.category.color}">
                  {{exp.category.name}}
                </span>
              </td>
              <td>
                <div *ngIf="exp.tags && exp.tags.length" style="display: inline-block;">
                  <span *ngFor="let tag of exp.tags"
                        class="bottom-bradius"
                        [ngStyle]="{'border-bottom': '8px solid' + tag.color}">
                    {{tag.name}}
                  </span>
                </div>
              </td>
              <td>{{exp.payed}}</td>

              <td class="text-center">
                <button pButton
                        pTooltip="Edit"
                        class="ui-button-info ui-button-raised"
                        type="button"
                        routerLink="edit/{{exp.id}}"
                        icon="pi pi-pencil"
                        iconPos="left">
                </button>
                <button pButton
                        pTooltip="Delete"
                        class="ui-button-danger ui-button-raised"
                        type="button"
                        (click)="displayDeleteRow(exp)"
                        icon="pi pi-trash"
                        iconPos="left">
                </button>
                <button *ngIf="exp.payed > 0"
                        pTooltip="Display rates"
                        pButton
                        class="ui-button-secondary ui-button-raised"
                        type="button"
                        (click)="fetchAndDisplayRates(exp)"
                        icon="pi pi-sitemap"
                        iconPos="left">
                </button>
              </td>
            </tr>
          </ng-template>
        </p-table>
        <div class="text-center font-weight-bold font-italic bg-light p-2"
             *ngIf="!expenses.length">
          {{tableDefaults.noData}}
        </div>
      </div>

    </div>
  </div>
</div>
